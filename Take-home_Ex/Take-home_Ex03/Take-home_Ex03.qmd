---
title: "Take-home Exercise 3"
author: "Sarthak Nagapurkar"
date: "May 22, 2024"
date-modified: "last-modified"
execute: 
  eval: true
  echo: true
  warning: false
---

## Project: VAST Challenge 2024 - Mini-Challenge 2

See link below for additional details on this challenge!

[https://vast-challenge.github.io/2024/index.html](https://vast-challenge.github.io/2024/)

## Project Overview

In Oceanus, the routine life of islanders is defined by the movements of commercial fishing vessels, which usually indicate a healthy economy. However, this routine was disrupted when SouthSeafood Express Corp was caught fishing illegally, causing a significant scandal in the fishing community. FishEye International, a non-profit dedicated to combating illegal fishing, is collecting and analyzing data on ship movements and shipping records to understand this disruption better. They have compiled this data into CatchNet: the Oceanus Knowledge Graph. FishEye’s analysts need assistance in creating analytical capabilities to make sense of this data and better understand local commercial fishing behavior.

## Project Objectives

This study aims to use visual analytics to understand patterns of groups in the knowledge graph. This will endeavour to:

-   FishEye analysts have long wanted to better understand the flow of commercially caught fish through Oceanus’s many ports. But as they were loading data into CatchNet, they discovered they had purchased the wrong port records. They wanted to get the ship off-load records, but they instead got the port-exit records (essentially trucks/trains leaving the port area). Port exit records do not include which vessel that delivered the products. Given this limitation, develop a visualization system to associate vessels with their probable cargos. Which vessels deliver which products and when? What are the seasonal trends and anomalies in the port exit records?
-   Develop visualizations that illustrate the inappropriate behavior of SouthSeafood Express Corp vessels. How do their movement and catch contents compare to other fishing vessels? When and where did SouthSeafood Express Corp vessels perform their illegal fishing? How many different types of suspicious behaviors are observed? Use visual evidence to justify your conclusions.
-   To support further Fisheye investigations, develop visual analytics workflows that allow you to discover other vessels engaging in behaviors similar to SouthSeafood Express Corp’s illegal activities? Provide visual evidence of the similarities.
-   How did fishing activity change after SouthSeafood Express Corp was caught? What new behaviors in the Oceanus commercial fishing community are most suspicious and why?

## Installing Packages

Let's install the required packages for addressing the challenges.

```{r}
#| code-fold: true
#| code-summary: "Show the code"
pacman::p_load(jsonlite, tidygraph, ggraph, igraph,
               visNetwork, graphlayouts, tidyverse, sf, leaflet, plotly, gganimate,
               gifski)
```

## Importing the data

Let's import the data given for the challenges

```{r}
mc2_data <- fromJSON("data/MC2.json")
geog <- st_read("data/Oceanus Geography.geojson")
```

### Data Preparation

First we have the data from the Transponder pings. Let us isolate out that data so that we can use it in the future as and when required.

```{r}
#| code-fold: true
#| code-summary: "Show the code"
mc2_ping <-
  as_tibble(mc2_data$links) %>%
  distinct() %>%
  mutate(source =
           as.character(source),
         target=
           as.character(target),
         type = as.character(type),
         time = as.character(time),
         arrivaldate = as.character(as.Date(time, format = "%Y-%m-%dT%H:%M:%S"))
  ) %>%
  filter((source != target) & type == 'Event.TransportEvent.TransponderPing') %>%
  select(source, target, type, time, dwell, arrivaldate)
```

## Investigating SouthSeaFoodCorp Vessels

Next, let us prepare the data for visualizing the pings of SouthSeaFood Corp Vessels. They are snappersnatcher7be and roachrobberdb6. Here we should be able to identify some suspicious behaviour.

::: panel-tabset
## Snappersnatcher7be

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| fig-height: 12
#| fig-width: 12
mc2ping_nodes <- mc2_data$nodes
mc2ping_nodes <- mc2ping_nodes %>% filter(type == 'Entity.Location.Region' | type =='Entity.Location.City' | type == 'Entity.Location.Point' | id == 'snappersnatcher7be' | id == 'roachrobberdb6') %>% rename(Location = id) 
mc2ping_nodes <- mc2ping_nodes %>% mutate(id = seq_len(nrow(mc2ping_nodes)))

mc2ping_edges <- mc2_ping %>%
  group_by(source, target) %>%
    summarise(weight = n()) %>%
  filter(source!=target) %>%
  filter(target == "snappersnatcher7be") %>%
  filter(weight > 1) %>%
  ungroup()

mc2ping_edges_agg <- mc2ping_edges %>%
  left_join(mc2ping_nodes, by= c("source" = "Location")) %>%
  rename(from = id) %>%
  left_join(mc2ping_nodes, by= c("target" = "Location")) %>%
  rename(to = id)
snappergraph <- tbl_graph(nodes = mc2ping_nodes,
                           edges = mc2ping_edges_agg,
                           directed = TRUE)

snappergraph <- snappergraph %>% 
  activate(nodes) %>% 
  filter(!node_is_isolated())
g <- snappergraph %>% 
  ggraph(layout = "nicely") +
  geom_edge_link(aes(width=weight), 
                 alpha=0.8) +
   scale_edge_width(range = c(0.1,5)) +
  geom_node_point(aes(colour = Location, size = 5)) +
  geom_node_text(aes(label = Location), vjust = 1.5)
g + theme_graph()
```

## Roachrobberdb6

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| fig-height: 12
#| fig-width: 12
mc2ping_roach_edges <- mc2_ping %>%
  group_by(source, target) %>%
    summarise(weight = n()) %>%
  filter(source!=target) %>%
  filter(target == "roachrobberdb6") %>%
  filter(weight > 1) %>%
  ungroup()

mc2ping_roach_edges_agg <- mc2ping_roach_edges %>%
  left_join(mc2ping_nodes, by= c("source" = "Location")) %>%
  rename(from = id) %>%
  left_join(mc2ping_nodes, by= c("target" = "Location")) %>%
  rename(to = id)

roachrobbergraph <- tbl_graph(nodes = mc2ping_nodes,
                           edges = mc2ping_roach_edges_agg,
                           directed = TRUE)
roachrobbergraph <- roachrobbergraph %>% 
  activate(nodes) %>% 
  filter(!node_is_isolated())
g <- roachrobbergraph %>% 
  ggraph(layout = "nicely") +
  geom_edge_link(aes(width=weight), 
                 alpha=0.8) +
   scale_edge_width(range = c(0.1,5)) +
  geom_node_point(aes(colour = Location, size = 5)) +
  geom_node_text(aes(label = Location), vjust = 1.5)
g + theme_graph()
```
:::

::: callout-tip
## Insights:

-   Snappersnatcher7be has made some visits to Ghoti Preserve and looking at the dwell time spent from the dataset there it clearly shows that a higher amount of time was spent there. Hence it could possibly be a suspicious illegal fishing activity carried out at Ghoti Preserve by snappersnatcher7be.

-   Roachrobberdb6 has made frequent visits to Wrasse Beds and Nav C. This is a suspicious behaviour as the fish caught at Wrasse Beds isn't seeming to go to the port directly for offloading but is going to Nav C and it seems it is going to be offloaded to another vessel at Nav C. This indicates a possible transshipment hapenning at point Nav C.
:::

### Prepare data for plotting paths of vessels

```{r}
centroids <- st_centroid(geog)
geog$centroid_x <- st_coordinates(centroids)[, 1]
geog$centroid_y <- st_coordinates(centroids)[, 2]
mc2_vessel_mov <- mc2_ping %>%
  left_join(geog,
            by = c("source" = "Name"))
vessel_movement_sf <- mc2_vessel_mov %>%
  filter(!is.na(centroid_x) & !is.na(centroid_y)) %>%
  st_as_sf(coords = c("centroid_x", "centroid_y"), crs = 4326)

vessel_movement_sf <- vessel_movement_sf %>%
  arrange(target, time)
```

### Investigating paths of SouthSeaFoodCorp Vessels

::: panel-tabset
## Snappersnatcher7be

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| fig-height: 12
#| fig-width: 12
geog2 <- st_read("data/Oceanus Geography.geojson")
geog2 <- st_centroid(geog2)

vessel_trajectory <- vessel_movement_sf %>%
  group_by(target) %>%
  summarize(do_union = FALSE) %>%
  st_cast("LINESTRING")
vessel_trajectory_selected <- vessel_trajectory %>%
  filter(target == "snappersnatcher7be")


ggplot(data = geog2) +
  geom_sf(data = geog2) +
  geom_sf(data = vessel_trajectory_selected, 
          aes(color = factor(target)), 
          size = 1) +
   geom_sf_text(aes(label = Name, geometry = geometry), size = 3, color = "black") +
  theme_minimal() +
  labs(title = "Trajectories of snappersnacther7be", 
  x = "Longitude", y = "Latitude", color = "ID")
```

## Roachrobberdb6

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| fig-height: 12
#| fig-width: 12
vessel_trajectory_selected <- vessel_trajectory %>%
  filter(target == "roachrobberdb6")


p <- ggplot(data = geog2) +
  geom_sf(aes(geometry = geometry)) +
  geom_sf_text(aes(label = Name, geometry = geometry), size = 3, color = "black") +
  geom_sf(data = vessel_trajectory_selected, 
          aes(color = factor(target)), 
          size = 1) +
  theme_minimal() +
  labs(title = "Trajectories of roachrobberdb6", 
  x = "Longitude", y = "Latitude", color = "ID")
p
```
:::

::: callout-tip
## Insights:

-   Roachrobberdb6 which visits Nav C and Wrasse Beds at a very high frequency suggests that these two locations should be geographically close for it to carry out possible suspicious activities. From the vessel path we can already confirm that these points are geographically close.
:::

### Investigating the illegal activities and the time when they were caught.

```{r}
#| code-fold: true
#| code-summary: "Show the code"
mc2_nodes <- as_tibble(mc2_data$nodes) %>%
  mutate(name = as.character(name),
         id = as.character(id),
         type = as.character(type),
         date = as.character(as.Date(date)),
         qty = as.character(as.double(qty_tons),
         company = as.character(company)
                            )) %>%
  select(id, name, type, date, qty, company)

mc2_transaction <-
  as_tibble(mc2_data$links) %>%
  distinct() %>%
  mutate(source =
           as.character(source),
         target=
           as.character(target),
         type = as.character(type),
         date = as.character(date)
  ) %>%
  group_by(source, target, type) %>%
  filter((source != target) & type == 'Event.Transaction') %>%
  select(source, target, type, date)
mc2_deliveryreport <- mc2_nodes %>% filter(type == 'Entity.Document.DeliveryReport')
mc2_fish <- mc2_nodes %>% filter(type == 'Entity.Commodity.Fish')
mc2_loc <- mc2_nodes %>% filter(type == 'Entity.Location.City')
mc2_transaction_loc <- inner_join(mc2_loc, mc2_transaction, by = c("id" = "target"))
mc2_transaction_fish <- inner_join(mc2_fish, mc2_transaction, by = c("id" = "target"))
mc2_transaction_loc <- inner_join(mc2_transaction_fish, mc2_transaction_loc, by = c("source" = "source"))
mc2_transaction_loc <- inner_join(mc2_transaction_loc, mc2_deliveryreport, by = c("source" = "id"))
mc2_transaction_loc <- mc2_transaction_loc %>%
  mutate(suspect_arrival = as.character(as.Date(date,format = "%Y-%m-%d") - 1),
         suspect_arrival2 = as.character(as.Date(date,format = "%Y-%m-%d")),
         month = month(date))
```

```{r}
#| code-fold: true
#| code-summary: "Show the code"
mc2_vessels <- mc2_nodes %>% filter(type == 'Entity.Vessel.CargoVessel' |
                                           type == 'Entity.Vessel.Ferry.Cargo' |
                                      type == 'Entity.Vessel.FishingVessel' |
                                      type == 'Entity.Vessel.Research' |
                                      type == 'Entity.Vessel.Tour' |
                                      type == 'Entity.Vessel.Other')
mc2_vessels_ping <- mc2_vessels %>%
  inner_join(mc2_ping, by = c("id" = "target"))
mc2_vessels_ping <- mc2_vessels_ping %>%
  mutate(month = month(arrivaldate))
mc2_southsea_pings <- mc2_vessels_ping %>% filter(company == 'SouthSeafood Express Corp')

mc2_southsea_calls <- mc2_southsea_pings %>%
  group_by(id, month) %>%
  summarise(totalcalls = n()) %>%
  select(id, month, totalcalls)

ggplot(data = mc2_southsea_calls,
       aes(x = month, y = totalcalls, fill = id)) +
  geom_bar(stat = "identity") + 
  theme_minimal()
```

::: callout-tip
## Insights:

-   There are no pings by both SouthSeaFood Corp Vessels to any ports after month of May(05). This indicates a very clear possibility that SouthSeaFood Corp was caught in May.

-   Roachrobberdb6 has made an irregularly high number of pings in Feb and March indicating that a high number of the suspicious activities were made by it during Feb and March.
:::

### Investigating region-wise calls for SouthSeaFood Corp Vessels

Prepare the data for region-wise calls for SouthSeaFood Corp Vessels.

```{r}
#| code-fold: true
#| code-summary: "Show the code"
mc2_southsea <- inner_join(mc2_southsea_pings, geog,
                           by = c("source" = "Name"))
mc2_southsea_illegalact <- mc2_southsea %>% filter((X.Kind != 'city') &
                                          (X.Kind != 'Fishing Ground') )
mc2_southsea_susp_calls <- mc2_southsea %>%
  group_by(id, month, source) %>%
  summarise(totalcalls = n()) %>%
  select(id, month, source, totalcalls)
```

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| fig-height: 12
#| fig-width: 12
ggplot(data = mc2_southsea_susp_calls,
       aes(x = month, y = totalcalls, fill = id)) +
  facet_wrap(~ source) + 
  geom_bar(stat = "identity") + 
  theme_minimal()
```

::: callout-tip
## Insights:

-   Investigating region wise calls validates findings from the network graph as well as the time based plots plotted earlier. There seems to be an abnormally high number of pings by Roachrobberdb6 to Wrasse Beds and Nav C during February and March. The number of pings reduced thereafter in months of April and May.

-   Another insight is snappersnatcher7be visited and spent an abnormally high amount of time at Ghoti Preserve only in Feb and March. Later months of April and May never saw any visits to Ghoti Preserve.

-   This indicates the possibility of illegal and suspicious fishing activities occuring in Feb and March for both the SouthSeaFood Corp Vessels.
:::

## Investigating Fishing Vessels at Nemo Reef and Ghoti Preserve

From this initial analysis of Snappersnatcher7be, we find that it is pinging Ghoti Preserve and spending a considerable amount of time there. This is suspicious because Ghoti Preserve is an ecological preserve and fishing here is illegal.

Following a similar line of thought, let us identify the fishing vessels that spent a considerable amount of time(dwell \> 200000) at ecological preserves indicating that they might be possibly engaged in illegal fishing.

::: panel-tabset
## Nemo Reef

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| fig-height: 12
#| fig-width: 12
mc2ping_nemo_nodes <- mc2_data$nodes %>% filter(id == 'Nemo Reef' | type == 'Entity.Vessel.FishingVessel') %>% rename(Location = id)
mc2ping_nemo_nodes <- mc2ping_nemo_nodes %>% mutate(id = seq_len(nrow(mc2ping_nemo_nodes))) 

mc2ping_nemo_edges <- mc2_ping %>%
  group_by(source, target) %>%
    summarise(weight = max(dwell)) %>%
  filter(source!=target) %>%
  filter(source == "Nemo Reef") %>%
  filter(weight > 200000) %>%
  ungroup()

mc2ping_nemo_edges_agg <- mc2ping_nemo_edges %>%
  inner_join(mc2ping_nemo_nodes, by= c("source" = "Location")) %>%
  rename(from = id) %>%
  inner_join(mc2ping_nemo_nodes, by= c("target" = "Location")) %>%
  rename(to = id)

nemograph <- tbl_graph(nodes = mc2ping_nemo_nodes,
                           edges = mc2ping_nemo_edges_agg,
                           directed = TRUE)
nemograph <- nemograph %>% 
  activate(nodes) %>% 
  filter(!node_is_isolated())
g <- nemograph %>% 
  ggraph(layout = "nicely") +
  geom_edge_link(aes(width=weight), 
                 alpha=0.8) +
   scale_edge_width(range = c(0.1,5)) +
  geom_node_point(aes(colour = company, size = 5)) +
  geom_node_text(aes(label = Location), vjust = 2)
g + theme_graph()
```

## Ghoti Preserve

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| fig-height: 12
#| fig-width: 12
mc2ping_ghoti <- mc2_data$nodes %>% filter(id == 'Ghoti Preserve' | type == 'Entity.Vessel.FishingVessel') %>% rename(Location = id)
mc2ping_ghoti_nodes <- mc2ping_ghoti %>% mutate(id = seq_len(nrow(mc2ping_ghoti))) 

mc2ping_edges <- mc2_ping %>%
  group_by(source, target) %>%
    summarise(weight = max(dwell)) %>%
  filter(source!=target) %>%
  filter(source == "Ghoti Preserve") %>%
  filter(weight > 200000) %>%
  ungroup()

mc2ping_ghoti_edges_agg <- mc2ping_edges %>%
  inner_join(mc2ping_ghoti_nodes, by= c("source" = "Location")) %>%
  rename(from = id) %>%
  inner_join(mc2ping_ghoti_nodes, by= c("target" = "Location")) %>%
  rename(to = id)

ghotigraph <- tbl_graph(nodes = mc2ping_ghoti_nodes,
                           edges = mc2ping_ghoti_edges_agg,
                           directed = TRUE)
ghotigraph <- ghotigraph %>% 
  activate(nodes) %>% 
  filter(!node_is_isolated())
g <- ghotigraph %>% 
  ggraph(layout = "nicely") +
  geom_edge_link(aes(width=weight), 
                 alpha=0.8) +
   scale_edge_width(range = c(0.1,5)) +
  geom_node_point(aes(colour = company, size = 5)) +
  geom_node_text(aes(label = Location), vjust = 1.5)
g + theme_graph()
```
:::

::: callout-tip
## Insights:

-   barracudabandit836, solesseker47a, redfishraider677, sailfishseeker8d5 all seem to spend a considerable amount of time at Nemo Reef. Hence these fishing vessels and the companies they belong to are the most suspicious. The behaviour of these fishing vessels need to be investigated further.

-   brilliantbandit0a1,seabassbandit9ad, fishfinderb9d, salmonsnatcher19d and several others seem to be suspicious as identified by the Network Graph based on their higher dwell times at Ghoti Preserve.

-   As such the network cllearly helps us identify vessels and companies that are suspicious by looking at higher dwell time at the ecological preserves Ghoti Preserve and Nemo Reef. Further insights can be obtained by looking at the network graph.
:::

### Observing anomalies in Port Offloading records

Preparing the data for investigating port offloading records

```{r}
#| code-fold: true
#| code-summary: "Show the code"
mc2_nodes <- as_tibble(mc2_data$nodes) %>%
  mutate(name = as.character(name),
         id = as.character(id),
         type = as.character(type),
         date = as.character(as.Date(date)),
         qty = as.character(as.double(qty_tons),
         company = as.character(company)
                            )) %>%
  select(id, name, type, date, qty, company)

mc2_transaction <-
  as_tibble(mc2_data$links) %>%
  distinct() %>%
  mutate(source =
           as.character(source),
         target=
           as.character(target),
         type = as.character(type),
         date = as.character(date)
  ) %>%
  group_by(source, target, type) %>%
  filter((source != target) & type == 'Event.Transaction') %>%
  select(source, target, type, date)
```

```{r}
#| code-fold: true
#| code-summary: "Show the code"
mc2_deliveryreport <- mc2_nodes %>% filter(type == 'Entity.Document.DeliveryReport')
mc2_fish <- mc2_nodes %>% filter(type == 'Entity.Commodity.Fish')
mc2_loc <- mc2_nodes %>% filter(type == 'Entity.Location.City')
mc2_transaction_loc <- inner_join(mc2_loc, mc2_transaction, by = c("id" = "target"))
mc2_transaction_fish <- inner_join(mc2_fish, mc2_transaction, by = c("id" = "target"))
mc2_transaction_loc <- inner_join(mc2_transaction_fish, mc2_transaction_loc, by = c("source" = "source"))
mc2_transaction_loc <- inner_join(mc2_transaction_loc, mc2_deliveryreport, by = c("source" = "id"))
mc2_transaction_loc <- mc2_transaction_loc %>%
  mutate(suspect_arrival = as.character(as.Date(date,format = "%Y-%m-%d") - 1),
         suspect_arrival2 = as.character(as.Date(date,format = "%Y-%m-%d")),
         month = month(date))

mc2_portoffloadtotal <- mc2_transaction_loc %>%
  group_by(month, id.y) %>%
  summarize(totalqty = sum(as.double(qty)),
            totalcalls = n()) %>%
  select(id.y, month, totalqty, totalcalls)

mc2_portoffload <- mc2_transaction_loc %>%
  group_by(month, id.y, name.x) %>%
  summarize(totalqty = sum(as.double(qty)),
            totalcalls = n()) %>%
  select(id.y, name.x, month, totalqty, totalcalls)
```

### Histogram of Cargo Offload Transactions

```{r}
mc2_transaction_loc <- mc2_transaction_loc %>% mutate(qty = as.double(qty))
# Calculate median
median_value <- median(mc2_transaction_loc$qty)

# Calculate Q3 and IQR
Q3 <- quantile(mc2_transaction_loc$qty, 0.75)
IQR <- IQR(mc2_transaction_loc$qty)
upper_whisker <- Q3 + 1.5 * IQR
ggplot(mc2_transaction_loc, aes(x = as.double(qty))) +
  geom_histogram(binwidth = 5, fill = "blue", color = "black", alpha = 0.7) +
  geom_vline(aes(xintercept = median_value), linetype = "dotted", color = "red", size = 1) +
  geom_vline(aes(xintercept = upper_whisker), linetype = "dotted", color = "red", size = 1) +
  labs(title = "Histogram of Cargo offload transactions", x = "Quantity", y = "Frequency") +
  annotate("text", x = median_value, y = Inf, label = paste("Median:", round(median_value, 2)), vjust = 1, color = "red") +
  annotate("text", x = upper_whisker, y = Inf, label = paste("Upper Whisker:", round(upper_whisker, 2)), vjust = 1, color = "red") +
  theme_minimal()
```

::: callout-tip
## Insights:

-   Records above the Upper Whisker of Quantity 69 tonnes need to be investigated further as they seem to be outliers. There could be possible smuggling or suspicious transshipment which has caused the cargo qty to increase substantially.
:::

## Plotting the Cargo offload for various ports by time

```{r}
ggplot(data = mc2_portoffloadtotal,
       aes(x = month, y = totalqty)) +
  facet_wrap(~id.y) +
  geom_bar(stat = "identity") + 
  theme_minimal()
```

::: callout-tip
## Insights:

-   There is an abnormally high increase in the cargo offload quantity at City of Paackland, City of South Paackland and City of Lomark in the months August(08), September(09), October(10), November(11).

-   This coincides after SouthSeaFood Corp vessels stop pinging them in May(05). So this is possibly a illegal activity after SouthSeaFoodCorp was caught.
:::

### Diving deep into Cargo offload as per Fish species

```{r}
ggplot(data = mc2_portoffload,
       aes(x = month, y = totalqty, fill = name.x)) +
  facet_wrap(~id.y) +
  geom_bar(stat="identity") +
  theme_minimal()
```

::: callout-note
## Insights:

-   The abnormal rise in cargo offload at City of Paackland, City of South Paackland and City of Lomark is primarily due to abnromal increase in Cod/Gadus n.specificatae and Beauvoir/Habeas pisces.

-   These fish species and the vessels that possibly carry these fish species need to be investigated further.
:::

## Conclusion

We have been able to identify some suspicious activities through this analysis. There needs to be further investigation on insights mentioned in the previous points to confirm the illegal activities and drill down on the kind of illegal activities.
